<!DOCTYPE html>

<html>

	<head>
		<title>Map Chat</title>
		<meta charset="utf-8" /> 
		<link rel="stylesheet" href="style.css" />
		<script src="https://maps.google.com/maps/api/js?sensor=true"></script>
		<script>

			var mylogin = 'GlendaSmith';
			var mylat = 0;
			var mylng = 0;
			var map;
			infowindow = new google.maps.InfoWindow();

			var url = "https://secret-about-box.herokuapp.com/sendLocation";
			var msg = encodeURIComponent("Movement to rename Dewick #FairRecognition #DontShaftMacPhie #MacPhieLivesMatter")
			var param
			var friendsdata;
			
			function mapinfo()
			{
				/*************** My Info ***************/
				if (navigator.geolocation)
				{
					navigator.geolocation.getCurrentPosition(function(position)
					{
						mylat = position.coords.latitude;
						mylng = position.coords.longitude;
						param = "login=" + mylogin + "&lat=" + mylat + "&lng=" + mylng + "&message=" + msg;
						post();
					});
				}
				else alert("Geolocation not supported -- try a different browser.");

			}

			function post()
			{
				var xhr = new XMLHttpRequest();
				xhr.open("POST", url, true);
				xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xhr.setRequestHeader("Content-length", param.length);
				xhr.setRequestHeader("Connection", "close");
				xhr.onreadystatechange = function()
				{
					if (xhr.readyState == 4 && xhr.status == 200)
					{
						friendsdata = JSON.parse(xhr.responseText);
						initMap();
					}
				}
				xhr.send(param);
			}

			function initMap()
			{
				/*************** MAP ***************/
				map = new google.maps.Map(document.getElementById("map_canvas"),
				{
					center: {lat: mylat, lng: mylng},
					zoom: 15
  				});

  				for (i = 0; i < friendsdata.length; i++)
  				{

  					if (friendsdata[i]["login"] == mylogin)
  					{
  						var marker = new google.maps.Marker(
  						{
  							position: new google.maps.LatLng(mylat, mylng),
  							title: mylogin,
  							icon: 'star.png'
  						});
  					}

  					else var marker = new google.maps.Marker(
  					{
  						position: new google.maps.LatLng(
  							friendsdata[i]["lat"],
  							friendsdata[i]["lng"]),
  						title: friendsdata[i]["login"],
  					});

  					var markerlat = marker.getPosition().lat();
  					var markerlng = marker.getPosition().lng();

  					if (friendsdata[i]["login"] == mylogin)
  						marker.content = "<div id='window'>It's you, " + mylogin +"!</div>";

  					else marker.content = "<div id='window'>" + friendsdata[i]["login"] + ":<br/>" + friendsdata[i]["message"]
  						+ "<br/>" + distFromMe(markerlat, markerlng) + " miles from you</div>";

  					google.maps.event.addListener(marker, 'click', function()
  					{
						infowindow.setContent(this.content);
						infowindow.open(map, this);
					});

					marker.setMap(map);
  				};
			}

			function distFromMe(tlat, tlng)
			{
				var R = 3958.756; // miles
				var lat1 = toRadians(tlat);
				var lat2 = toRadians(mylat);
				var latchange = toRadians(mylat-tlat);
				var lngchange = toRadians(mylng-tlng);

				var a = Math.sin(latchange/2) * Math.sin(latchange/2) +
       			Math.cos(lat1) * Math.cos(lat2) *
        		Math.sin(lngchange/2) * Math.sin(lngchange/2);
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

				var dist = R * c;
				return dist.toFixed(4);
			}

			function toRadians(num)
			{
				return num * Math.PI / 180;
			}

		</script>
	</head>

	<body onload="mapinfo()">
		<div id="map_canvas"></div>
	</body>

</html>