<!DOCTYPE html>

<html>

	<head>
		<title>Map Chat</title>
		<meta charset="utf-8" /> 
		<link rel="stylesheet" href="style.css" />
		<script src="https://maps.google.com/maps/api/js?sensor=true"></script>
		<script>

			var mylat = 0;
			var mylng = 0;
			var map;
			infowindow = new google.maps.InfoWindow();

			var url = "https://secret-about-box.herokuapp.com/sendLocation";
			var msg = encodeURIComponent("Movement to rename Dewick #FairRecognition #DontShaftMacPhie #MacPhieLivesMatter")
			var param
			var friendsdata;
			
			function mapinfo()
			{
				/*************** My Info ***************/
				if (navigator.geolocation)
				{
					navigator.geolocation.getCurrentPosition(function(position)
					{
						mylat = position.coords.latitude;
						mylng = position.coords.longitude;
						param = "login=GlendaSmith&lat=" + mylat + "&lng=" + mylng + "&message=" + msg;
						post();
					});
				}
				else alert("Geolocation not supported -- try a different browser.");

			}

			function post()
			{
				var xhr = new XMLHttpRequest();
				xhr.open("POST", url, true);
				xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xhr.setRequestHeader("Content-length", param.length);
				xhr.setRequestHeader("Connection", "close");
				xhr.onreadystatechange = function()
				{
					if (xhr.readyState == 4 && xhr.status == 200)
					{
						friendsdata = JSON.parse(xhr.responseText);
						initMap();
					}
				}
				xhr.send(param);
			}

			function initMap()
			{
				/*************** MAP ***************/
				map = new google.maps.Map(document.getElementById("map_canvas"),
				{
					center: {lat: mylat, lng: mylng},
					zoom: 15
  				});

  				for (i = 0; i < friendsdata.length; i++)
  				{
  					var marker = new google.maps.Marker(
  					{
  						position: new google.maps.LatLng(
  							friendsdata[i]["lat"],
  							friendsdata[i]["lng"]),
  						title: friendsdata[i]["login"]
  					});

  					marker.content = friendsdata[i]["login"] + " says: " + friendsdata[i]["message"];

  					google.maps.event.addListener(marker, 'click', function()
  					{
						infowindow.setContent(this.content);
						infowindow.open(map, this);
					});

					marker.setMap(map);
  				};
			}

		</script>
	</head>

	<body onload="mapinfo()">
		<div id="map_canvas"></div>
	</body>

</html>